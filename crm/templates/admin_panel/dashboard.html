{% extends "admin_panel/layout.html" %}
{% load static %}

{% block title %}
    <title>SportyCredit - Dashboard</title>
{% endblock %}

{% block content %}

		<!--start page wrapper -->
		<div class="page-wrapper">
			<div class="page-content">


                <div class="card shadow-none bg-transparent border-bottom border-2 mb-4">
                   <div  class="card-body">
                      <div class="d-flex align-items-center bg-light p-3 flex-wrap">
                        <div class="me-auto fw-bold fs-3">Dashboard</div>
                        <div class="d-flex align-items-center flex-wrap">
                            <div class="me-2">
                                <label for="history_month_start" class="form-label me-1">From:</label>
                                <input type="date" class="form-control d-inline-block"
                                       style="width: auto;" id="timeframe_from" value="2024-01-01">
                            </div>
                            <div class="me-2">
                                <label for="history_month_end" class="form-label me-1">To:</label>
                                <input type="date" id="timeframe_to" class="form-control d-inline-block" value=""
                                       style="width: auto;">
                            </div>
                            <div>
                                <button id="search_rdp" type="button" class="btn btn-primary px-3 radius-30"
                                        onclick="start(true)">Update
                                </button>
                            </div>
                        </div>
                    </div>
                   </div>
                </div>


				<div class="row row-cols-1 row-cols-md-2 row-cols-xl-5">

					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0">Main Balance</p>
										<h5 class="mb-0">&#x20A6;<span class="main_bal">...</span></h5>
									</div>
									<div class="dropdown ms-auto">
										<a class="dropdown-toggle dropdown-toggle-nocaret" href="#" data-bs-toggle="dropdown"><i class='bx bx-dots-horizontal-rounded font-22 text-option'></i>
										</a>
										<ul class="dropdown-menu">
											<li><a class="dropdown-item mask-btn" href="javascript:;" onclick="mask_balance()">Mask Balance</a>
											</li>
											<li><a class="dropdown-item" href="javascript:;" onclick="reload_main_bal()">Reload</a>
											</li>
										</ul>
									</div>
								</div>
								<div class="" id="chart4"></div>
							</div>
						</div>
					</div>


                    <div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0">Pending Loan <i class="bx bxs-alarm-exclamation text-warning fs-6"></i></p>
										<h5 class="mb-0">&#x20A6;<span class="pending_amount">0</span></h5>
									</div>
								</div>
								<div class="" id="chart5"></div>
							</div>
						</div>
					</div>


					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0">Disbursed</p>
										<h5 class="mb-0">&#x20A6;<span class="disbursed_amount">0</span></h5>
									</div>

								</div>
								<div class="" id="disbursed_chart"></div>
							</div>
						</div>
					</div>

					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0">Repayment</p>
										<h5 class="mb-0">&#x20A6;<span class="repaid_amount">0</span></h5>
									</div>
								</div>
								<div class="" id="chart2"></div>
							</div>
						</div>
					</div>


                    <div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0">Declined</p>
										<h5 class="mb-0 ">&#x20A6;<span class="declined_amount">0</span></h5>
									</div>
								</div>
								<div class="" id="chart10"></div>
							</div>
						</div>
					</div>
				</div>



{#   ----------------- PRESENT STATS -------------------------#}

                <h6 class="mb-0 text-uppercase">Present Stats</h6>
                <hr>

                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">

					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Pending Loans <i class="bx bxs-alarm-exclamation text-warning fs-6"></i></p>
										<h4 class="my-1"><span class="pending_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-warning text-warning ms-auto"><i class="bx bxs-time-five"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Approved Loans</p>
										<h4 class="my-1"><span class="approved_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-info text-info ms-auto"><i class="bx bxs-check-circle"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Disbursed Loans</p>
										<h4 class="my-1"><span class="disbursed_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-success text-success ms-auto"><i class="bx bxs-badge-dollar"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Declined Loans</p>
										<h4 class="my-1"><span class="declined_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-danger text-danger ms-auto"><i class="bx bx-x-circle"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

                    <div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Repaid Loans</p>
										<h4 class="my-1"><span class="repaid_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-success text-success ms-auto"><i class="bx bxs-credit-card"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

                    <div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Part-payment Loans <i class="bx bxs-alarm-exclamation text-warning fs-6"></i></p>
										<h4 class="my-1"><span class="partpayment_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-info text-info ms-auto"><i class="bx bxs-credit-card-alt"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

                    <div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Due Today Loans <i class="bx bxs-alarm-exclamation text-warning fs-6"></i></p>
										<h4 class="my-1"><span class="due_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-primary text-primary ms-auto"><i class="bx bxs-calendar"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

                    <div class="col">
						<div class="card radius-10">
							<div class="card-body">
								<div class="d-flex align-items-center">
									<div>
										<p class="mb-0 text-secondary">Overdue Loans <i class="bx bxs-alarm-exclamation text-warning fs-6"></i></p>
										<h4 class="my-1"><span class="overdue_count">0</span></h4>
									</div>
									<div class="widgets-icons bg-light-danger text-danger ms-auto"><i class="bx bxs-alarm"></i>
									</div>
								</div>
							</div>
						</div>
					</div>

				</div>



                
{#   ----------------- DISBURSED VS REPAID CHART-------------------------#}
                <div class="row row-cols-1 row-cols-md-12 row-cols-xl-12">
					<div class="">
						<div class="card radius-10">
							<div class="card-body">
								<div id="disbursed_vs_repaid_chart" data-highcharts-chart="0" style="overflow: hidden;"></div>
							</div>
						</div>
					</div>
				</div>




 {#   ----------------- HISTORICAL STATS CHART-------------------------#}

                <div class="row row-cols-1 row-cols-md-12 row-cols-xl-12">
					<div class="">
						<div class="card radius-10">
							<div class="card-body">
                                <div class="d-flex align-items-center bg-light p-3">
                                    <div class="me-auto fw-bold fs-5">Historical chart</div>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <div class="form-check form-switch">
                                                <input id="historical_check" class="form-check-input" type="checkbox" role="switch" checked="checked" onchange="start(true)">
                                                <label class="form-check-label" >Count/Amount</label>
                                              </div>
                                        </div>
                                    </div>
                                </div>
								<div id="historical_stats_chart" data-highcharts-chart="0" style="overflow: hidden;"></div>
							</div>
						</div>
					</div>
				</div>






			</div>
		</div>
		<!--end page wrapper -->

		<input type="hidden" id="general_username">



		<!--MODAL FOR USER PROFILE-->


	<div  id="exampleLargeModal1" tabindex="-1" class="modal fade show" style="display: none;" aria-modal="true" role="dialog">
		    <div  class="modal-dialog modal-xl modal-dialog-scrollable">
		        <div  class="modal-content">
		            <div  class="modal-header">
		                <h5  class="modal-title">Profile</h5>
		                <button  type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close" id="close_user"></button>
		                </div>


			                 <div  class="modal-body">





            			    <div  class="page-content">
   <router-outlet ></router-outlet>
   <app-user-profile _nghost-ehg-c192="">
      <div  class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
         <div  class="breadcrumb-title pe-3">User Profile</div>
         <div  class="ps-3">
            <nav  aria-label="breadcrumb">
               <ol  class="breadcrumb mb-0 p-0">
                  <li  class="breadcrumb-item"><a  href="#"><i  class="bx bx-home-alt"></i></a></li>
                  <li  aria-current="page" class="breadcrumb-item active">Account Username: <span class="details_code">110000001</span></li>
               </ol>
            </nav>
         </div>

         <!---------------TOP ACTIONS------------------->
         <div  class="ms-auto">
            <div  class="btn-group">
               <button  data-bs-toggle="dropdown" type="button" class="btn btn-primary">More Actions</button><button  type="button" data-bs-toggle="dropdown" class="btn btn-primary split-bg-primary dropdown-toggle dropdown-toggle-split"><span  class="visually-hidden">Toggle Dropdown</span></button>
               <div  class="dropdown-menu dropdown-menu-right dropdown-menu-lg-end">
                  <a  href="#" class="dropdown-item view_deposit_history text-primary" data-bs-toggle='modal' data-bs-target='#DepositModal'><i class="lni lni-cloud-download"></i> Deposits <span class="badge rounded-pill bg-primary m-1 deposit_count">0</span></a>

                  <a  href="#" class="dropdown-item view_with_history text-dark" data-bs-toggle='modal' data-bs-target='#WithModal'><i class="lni lni-cloud-upload"></i> Withdrawals <span class="badge rounded-pill bg-dark m-1 with_count">0</span></a>

                  <a  href="#" class="dropdown-item view_trade_history text-secondary" data-bs-toggle='modal' data-bs-target='#CryptoTradeModal'><i class="lni lni-graph"></i> Crypto Trades <span class="badge rounded-pill bg-secondary m-1 trade_count">0</span></a>

                  <a  href="#" class="dropdown-item view_trade_history2 text-info" data-bs-toggle='modal' data-bs-target='#StockTradeModal'><i class="fadeIn animated bx bx-line-chart"></i> Stock Trades <span class="badge rounded-pill bg-info m-1 trade2_count">0</span></a>

                  <a  href="#" class="dropdown-item view_invest_history text-warning" data-bs-toggle='modal' data-bs-target='#InvestModal'><i class="lni lni-investment"></i> Investments <span class="badge rounded-pill bg-warning m-1 invest_count">0</span></a>
                  <!--<a  href="#" class="dropdown-item view_with_trans text-secondary" data-bs-toggle='modal' data-bs-target='#WithTransModal'>View Withdrawals</a>-->

                  <div  class="dropdown-divider"></div>
                  {% if current_user.role == 'admin' %}
                  <a  href="#0" class="dropdown-item text-primary assign" style="font-weight: bold" data-bs-toggle='modal' data-bs-target='#AssignModal'><i class="lni lni-network"></i> Assign To Agent</a>
                  {% endif %}
                  <div  class="dropdown-divider"></div>
                  <a  href="#" class="dropdown-item top_actions text-warning" style="font-weight: bold" data-action="ban"><i class="lni lni-ban"></i> Ban/Unban User</a>
                  <a  href="#" class="dropdown-item" style="color: red; font-weight: bold" data-bs-toggle='modal' data-bs-target='#EraseUserModal'><i class="lni lni-trash"></i> Delete Account</a>
               </div>
            </div>
         </div>


      </div>
      <div  class="container">
         <div  class="main-body">
            <div  class="row">
               <div  class="col-lg-4">
                  <div  class="card">
                     <div  class="card-body">


                         <!--------------------AVATAR AND USER NAMES---------------------->
                        <div  class="d-flex flex-column align-items-center text-center">
                           <img  src="{% static 'admin_panel/images/avatars/avatar-2.png' %}" alt="Admin" width="110" class="rounded-circle p-1 bg-primary details_avatar">
                           <div  class="mt-3">
                              <h4  class="details_fullname"></h4>
                              <p  class="mb-1 details_status" style="text-transform: capitalize; font-weight: bold">Active</p>
                              <p  class="text-muted font-size-sm">Registered: <span class="details_registered"></span></p>
                              <p  class="text-muted font-size-sm"><span class="text-warning fw-bold">See <a href="">All Members</a> page for more/accurate details</span></p>
                              <button  class="btn btn-primary m-1" data-bs-toggle='modal' data-bs-target='#DocsModal'><i class="fadeIn animated bx bx-book-content"></i> View Docs</button>
                              <button  class="btn btn-outline-primary view_note" data-bs-toggle='modal' data-bs-target='#NoteModal' ><i class="fadeIn animated bx bx-pencil"></i> Notes</button>
                           </div>
                        </div>

                        <hr  class="my-4">


                        <!--------------------MINI TRANSACTION HISTORY---------------------->
                        <h5 style="font-size:1.2em; font-weight: bold">Mini Transactions History</h5>

                        <div ></div>
                        <ul  class="list-group list-group-flush details_trans_loader" style="width:50% !important; background: blue !important">
                           <li  class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                               <div id="loader-trans">
                              <img src="{% static 'admin_panel/css/ajax-loader.gif' %}" alt="" width="30px">
                              </div>
                           </li>
                        </ul>

                        <ul  class="list-group list-group-flush details_trans">

                        </ul>


                     </div>
                  </div>
               </div>




               <!--------------------MAIN PROFILE---------------------->
               <div  class="col-lg-8">
                  <div  class="card">
                     <div  class="card-body">

                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="fadeIn animated bx bx-user"></i> Full Name</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="John" class="form-control details_fullname edit_profile" data-key="fullname" data-table="members"></div>
                        </div>


                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="fadeIn animated bx bx-mail-send"></i> Email</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="john@example.com" class="form-control details_email edit_profile"  data-key="email" data-table="members"></div>
                        </div>
                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="fadeIn animated bx bx-phone"></i> Phone</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="(239) 816-9029" class="form-control details_phone edit_profile" data-key="phone" data-table="members"></div>
                        </div>
                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="fadeIn animated bx bx-current-location"></i> State</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="Bay Area, San Francisco, CA" class="form-control details_city edit_profile" data-key="city" data-table="members"></div>
                        </div>
                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-map-marker"></i> Country</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="" class="form-control details_country edit_profile" data-key="country" data-table="members"></div>
                        </div>
                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-calendar"></i> Signed Up</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type='datetime-local' class='form-control details_reg_date date' data-key="reg_date" data-table="members"></div>
                        </div>

                        <hr  class="my-4">

                        <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-wallet"></i> Account Equity</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="0.00" class="form-control details_equity" readonly></div>
                        </div>

                         <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-wallet"></i> Total Spot Wallet</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="0.00" class="form-control details_total_spot" readonly></div>
                        </div>

                         <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-wallet"></i> Total Balance Wallet</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="0.00" class="form-control details_total_bal" data-table="members" readonly></div>
                        </div>

                         <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-investment"></i> Investment ROI</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="number" value="0.00" class="form-control details_bonus edit_profile" data-key="program_cash" data-table="members"></div>
                        </div>


                         <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-cloud-download"></i> Total Deposit</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="0.00" class="form-control details_total_deposit" readonly></div>
                        </div>

                         <div  class="row mb-3">
                           <div  class="col-sm-3">
                              <h6  class="mb-0"><i class="lni lni-cloud-upload"></i> Total Withdrawn</h6>
                           </div>
                           <div  class="col-sm-9 text-secondary"><input  type="text" value="0.00" class="form-control details_total_with" readonly></div>
                        </div>


                     </div>
                  </div>


               </div>
            </div>
         </div>
      </div>
   </app-user-profile>
   <!--container-->
   <div  class="overlay" ng-reflect-ng-class="[object Object]"></div>
</div>




			    </div>
			</div>
		</div>
	</div>





    <script>
        const success_audio = new Audio("{% static 'admin_panel/audio/correct.mp3' %}");
        const error_audio = new Audio("{% static 'admin_panel/audio/wrong.mp3' %}");

        var overlay = $("#overlay");
        var loader = $("#loader");
        var loader_trans = $("#loader-trans");

        function loadOn() {
            overlay.css('display', 'block');
            loader.css('display', 'block');
        }

        function onProgress(elem) {
            $('#' + elem).addClass('thin-loader')
        }

        function offProgress(elem) {
            $('#' + elem).removeClass('thin-loader')
        }

        function loadOff() {
            overlay.css('display', 'none');
            loader.css('display', 'none');
        }

        function notify(status, message) {
            if (status === "success" || status === "info") {
                success_audio.play();
            } else {
                error_audio.play();
            }
            toastr[status](message)
        }

        function start(refresh=false) {
            loadOn()
            var historical_fetch = $('#historical_check').is(':checked') ? 'amount' : 'count'
            $.ajax({
                url: "{% url 'analysis' %}",
                type: "POST",
                data: {
                    action: 'fetch_dashboard',
                    fetch: historical_fetch,
                    start: $('#timeframe_from').val(),
                    end: $('#timeframe_to').val()
                },
                dataType: "json",
                success: function (data) {
                    loadOff()
                    update_chart(data.content['pending'], data.content['disbursed'], data.content['repaid'], data.content['declined'],historical_fetch, refresh)
                    update_chart2(data.content['disbursed'], data.content['repaid'], refresh)
                    var dashboard = data.content['dashboard']
                    $.each(dashboard, function (key, value){
                        if(key.endsWith('count')){
                            $('.'+key).text(value)
                        }else{
                            $('.'+key).text(formatAmount(Number(value.replaceAll(',', ''))))
                        }
                    })
                    update_main_balance(data.content['main_bal'])
                },
                error: function (jqXHR, errorThrown) {
                    loadOff()
                    notify('error', 'An error occurred. Page will be refreshed in 3s')
                    setTimeout(function () {
                        {#window.location.update()#}
                    }, 3000)
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                }
            })
        }

        window.e1_chart;
        function update_chart(pending, disbursed, repaid, declined, fetch, refresh=false){
            {#   ----------------- HISTORICAL STATS CHART -------------------------#}
            if(refresh){
                if (e1_chart && typeof e1_chart.destroy === 'function') {
                    e1_chart.destroy();
                }
            }

            var e1 = {
                series: [{
                    name: 'Pending',
                    data: pending
                }, {
                    name: 'Disbursed',
                    data: disbursed
                }, {
                    name: 'Repaid',
                    data: repaid
                }, {
                    name: 'Declined',
                    data: declined
                }],
                chart: {
                    foreColor: '#9ba7b2',
                    type: 'bar',
                    height: 360
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '55%',
                        endingShape: 'rounded'
                    },
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                title: {
                    text: '',
                    align: 'left',
                    style: {
                        fontSize: '14px'
                    }
                },
                colors: ["#ffc107", '#6A49F2', '#15ca20', '#fd3550'],
                xaxis: {
                    categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                },
                yaxis: {
                    title: {
                        text: fetch.toUpperCase()
                    },
                    labels: {
                        formatter: function (val) {
                            return fetch === 'amount' ? "₦ " + formatNumber(val) : formatNumber(val)
                        }
                    }
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return fetch === 'amount' ? "₦ " + formatNumber(val) : formatNumber(val)
                        }
                    }
                }
	        };
            window.e1_chart = new ApexCharts(document.querySelector("#historical_stats_chart"), e1);
            e1_chart.render();

        }


        window.e2_chart;
       function update_chart2(disbursed, repaid, refresh){
            if(refresh){
                if (e2_chart && typeof e2_chart.destroy === 'function') {
                    e2_chart.destroy();
                }
            }
             var e2 = {
                chart: {
                    foreColor: '#9ba7b2',
                    height: 360,
                    type: 'line',
                    zoom: {
                        enabled: false
                    },
                    dropShadow: {
                        enabled: true,
                        top: 3,
                        left: 2,
                        blur: 4,
                        opacity: 0.1,
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 5
                },
                colors: ["#000", '#15ca20'],
                series: [{
                    name: "Disbursed",
                    data: disbursed
                }, {
                    name: "Repaid",
                    data: repaid
                }],
                title: {
                    text: 'Disbursed VS Repaid',
                    align: 'left',
                    offsetY: 25,
                    offsetX: 20
                },
                markers: {
                    size: 4,
                    strokeWidth: 0,
                    hover: {
                        size: 7
                    }
                },
                grid: {
                    show: true,
                    padding: {
                        bottom: 0
                    }
                },
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                xaxis: {
                    tooltip: {
                        enabled: false
                    }
                },
                yaxis: {
                    title: {
                        text: 'AMOUNT'
                    },
                    labels: {
                        formatter: function (val) {
                            return "₦ " + formatNumber(val)
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    offsetY: -20
                }
            }
            window.e2_chart = new ApexCharts(document.querySelector('#disbursed_vs_repaid_chart'), e2);
            e2_chart.render();
       }


        function get_current_day(cc = 1) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + cc).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }


        function mask_balance(){
           if(localStorage.getItem('mask_value') != null){
                if(localStorage.mask_value === 'masked'){
                    {#Now unmask#}
                    $('.main_bal').text(formatAmount(Number(localStorage.main_bal)))
                    $('.mask-btn').text('Mask Balance')
                    localStorage.mask_value = 'unmasked'
                }else{
                    {#Now mask#}
                    $('.main_bal').text('****.**')
                    $('.mask-btn').text('Unmask Balance')
                    localStorage.mask_value = 'masked'
                }
           }else{
               $('.main_bal').text('****.**')
               $('.mask-btn').text('Unmask Balance')
               localStorage.mask_value = 'masked'
           }
        }

        function update_main_balance(bal){
           localStorage.main_bal = bal
           if(localStorage.getItem('mask_value') == null){
                $('.main_bal').text(formatAmount(Number(bal)))
               $('.mask-btn').text('Mask Balance')
               localStorage.mask_value = 'unmasked'
           }else{
               if(localStorage.mask_value === 'unmasked'){
                    $('.main_bal').text(formatAmount(Number(bal)))
                   $('.mask-btn').text('Mask Balance')
                }else{
                   $('.main_bal').text('****.**')
                   $('.mask-btn').text('Unmask Balance')
               }
           }
        }

        function reload_main_bal(){
           $('.main_bal').text('...')
           $.ajax({
                url: "{% url 'analysis' %}",
                type: "POST",
                data: {
                    action: 'fetch_main_bal',
                },
                dataType: "json",
                success: function (data) {
                    update_main_balance(data.content)
                },
                error: function (jqXHR, errorThrown) {
                    notify('error', 'An error occurred. Page will be refreshed in 3s')
                    setTimeout(function () {
                        {#window.location.update()#}
                    }, 3000)
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                }
            })
        }



    </script>


	<script>
	    $(function(){
            $('#timeframe_to').val(get_current_day())
            start()
            reload_main_bal()



{#   ----------------- DISBURSED VS REPAID -------------------------#}


	        $("#order_search").keyup(function(){
	            var key= $(this).val().toLowerCase();
	            if(key !== ""){
	                $('.trs').each(function (){
                        const name = $(this).data('code').toLowerCase()
                        const fullname = $(this).data('fullname').toLowerCase()
                        if(name.startsWith(key) || fullname.startsWith(key)){
                            $(this).show();
                         }else{
                            $(this).hide();
                         }
                    })
	            }else{
                    $('.trs').show()
                }
	        })



	       $('body').on('click', '.trs', function(){
                var row= $(this);
                var fullname= row.data('fullname');
                var country= row.data('country');
                var email= row.data('email');
                var phone= row.data('phone');
                var reg_date= row.data('reg_date');
                var registered= row.data('registered');
                var city= row.data('state');
                var file_status= row.data('file_status');
                var file_name= row.data('file_name');
                var avatar_name= row.data('avatar_name');
                var equity= row.data('equity');
                var total_spot= row.data('total_spot');
                var total_bal= row.data('total_bal');
                var style= row.data('style');
                var status= row.data('status');
                var code= row.data('code');
                var bonus= row.data('bonus');
                var last_access= row.data('last_access');
                var id= row.data('id');
                var total_deposit= row.data('total_deposit');
                var total_with= row.data('total_with');
                var deposit_count= row.data('deposit_count');
                var with_count= row.data('with_count');
                var trade_count= row.data('trade_count');
                var trade2_count= row.data('trade2_count');
                var invest_count= row.data('invest_count');

                $(".details_fullname").val(fullname);
                $(".details_email").val(email);
                $(".details_city").val(city);
                $(".details_phone").val(phone);
                $(".details_reg_date").val(reg_date);
                $(".details_country").val(country);
                $(".details_bonus").val(bonus);
                $(".details_status").css('color', style+' !important');
                $(".details_status").text(status);
                $(".details_equity").val('$'+equity);
                $(".details_total_bal").val('$'+total_bal);
                $(".details_total_spot").val('$'+total_spot);

                $(".details_avatar").attr('src', "" + avatar_name);
                $(".details_last_access").text(last_access);
                $(".details_registered").text(registered);
                $(".details_code").text(code);
                $(".details_text_fname").text(fullname);
                $(".details_total_deposit").val('$'+total_deposit);
                $(".details_total_with").val('$'+total_with);
                $(".deposit_count").text(deposit_count);
                $(".with_count").text(with_count);
                $(".trade_count").text(trade_count);
                $(".trade2_count").text(trade2_count);
                $(".invest_count").text(invest_count);

                $(".details_file_src").attr('src', "" + file_name);
                $(".file_href").attr('href', "" + file_name);
                if(file_status== 1){
                    $(".details_file_status").text('Document is yet to be verified');
                    $(".details_file_status").css('color', 'blue')
                }else if(file_status== 2){
                    $(".details_file_status").text('Document has already been verified!');
                    $(".details_file_status").css('color', 'green')
                }else if(file_status== 100){
                    $(".details_file_status").text('Document was rejected, awaiting client...');
                    $(".details_file_status").css('color', 'red')
                }else if(file_status== 0){
                    $(".details_file_status").text('Client is yet to submit a document!');
                    $(".details_file_status").css('color', 'blue')
                }



                $(".details_reg_date").data('id', id)
                $(".details_deposited").data('id', id)
                $(".details_fullname").data('id', id)
                $(".details_addr").data('id', id)
                $(".details_phone").data('id', id)
                $(".details_addr").data('id', id)
                $(".details_email").data('id', id)
                $(".details_country").data('id', id)
                $(".details_city").data('id', id)
                $(".details_bonus").data('id', id)

                $(".view_tax_trans").data('username', code)
                $(".view_transfer_trans").data('username', code)
                $("#general_username").val(code);
                $('.details_trans_loader').show()


                $(".details_trans").html('<li  class="list-group-item d-flex justify-content-between align-items-center flex-wrap"><h6  class="mb-0">Loading </h6><span  class="text-secondary">...</span><span  class="text-secondary"></span></li>');
                // HANDLE TRABSACTION HISTORY FETCH
                $.post('', {
                    get_user_trans: "set",
                    username: code
                }, function(data, status){
                    $('.details_trans_loader').hide()
                    $(".details_trans").html(data.return);
                }, "JSON");

            })


            $('body').on('click', '.top_actions', function(){
                var action= $(this).data('action');
                loadOn();
                $.post('', {
                    top_actions: "set",
                    username: $("#general_username").val(),
                    action: action
                }, function(data, status){
                    loadOff();
                    if(data.err === 0){
                        notify('success', data.msg)
                        $.post('', {
            	            get_signup_history: "set",
            	            key: '*'
            	        }, function(data, status){
            	            loadOff();
            	            $("#members").html(data);
            	        })
            	        if(action === "erase"){
                    	     $("#close_user").trigger('click');
                    	 }
                    }else{
                        notify('error', data.msg)
                    }
                }, "JSON")
            })



	        $("body").on('blur', '.edit_profile', function(){
	            var id= $(this).data('id');
	            var key= $(this).data('key');
	            var table= $(this).data('table');
	            var username= $("#general_username").val();
	            var table2= $(this).data('table2');
	            var value= $(this).val();
	            $.post('', {
	                save_actions: "set",
	                id: id,
	                table: table,
	                value: value,
	                key: key,
	                username: username
	            }, function(data, status){
	                if(data.err === 1){
	                    notify('warning', data.msg)
	                }else if(data.err === 2){
	                    notify('error', data.msg)
	                }else{
                        if (data.msg !== ""){
                            notify('success', data.msg)
                        }
	                }

	                if(table === "members" && data.err === 0){
    	                $.post('', {
            	            get_signup_history: "set",
            	            key: '*'
            	        }, function(data, status){
            	            $("#members").html(data);
            	        })
    	            }else if(table2 === "deposit_history" && data.err === 0){
    	                $.post('', {
            	            get_deposit_history2: "set",
            	            username: username
            	        }, function(data, status){
            	            $("#deposit_history").html(data);
            	        })
    	            }else if(table2 === "with_history" && data.err === 0){
    	                $.post('', {
            	            get_with_history2: "set",
            	            username: username
            	        }, function(data, status){
            	            $("#with_history").html(data);
            	        })
    	            }else if(table2 === "invest_history" && data.err === 0){
    	                $.post('', {
            	            get_invest_history2: "set",
            	            username: username
            	        }, function(data, status){
            	            $("#invest_history").html(data);
            	        })
    	            }

	            }, "JSON")
	        })



	        $("body").on('change', '.date', function(){
	            var id= $(this).data('id');
	            var key= $(this).data('key');
	            var value= $(this).val();
	            var table= $(this).data('table');
	            var table2= $(this).data('table2');
	            var username= $("#general_username").val();
	            //loadOn();
	            $.post('', {
	                save_actions: "set",
	                id: id,
	                table: table,
	                value: value,
	                key: key,
                    username: username
	            }, function(data, status){
	                if(data.err === 1){
	                    notify('warning', data.msg)
	                }else if(data.err === 2){
	                    notify('error', data.msg)
	                }else{
	                    if (data.msg !== ""){
                            notify('success', data.msg)
                        }
	                }
	                //loadOn();
	                if(table === "members"){
    	                $.post('', {
            	            get_signup_history: "set",
            	            key: '*'
            	        }, function(data, status){
            	            //loadOff();
            	            $("#members").html(data);
            	        })
    	            }else if(table2 === "deposit_history"){
    	                $.post('', {
            	            get_deposit_history2: "set",
            	            username: username
            	        }, function(data, status){
            	            //loadOff();
            	            $("#deposit_history").html(data);
            	        })
    	            }else if(table2 === "with_history"){
    	                $.post('', {
            	            get_with_history2: "set",
            	            username: username
            	        }, function(data, status){
            	            //loadOff();
            	            $("#with_history").html(data);
            	        })
    	            }else if(table2 === "invest_history"){
    	                $.post('', {
            	            get_invest_history2: "set",
            	            username: username
            	        }, function(data, status){
            	            //loadOff();
            	            $("#invest_history").html(data);
            	        })
    	            }

	            }, "JSON")
	        })








	       // DEPOSIT TRANSACTIONS BLOCK
	       $(".view_deposit_history").click(function(){
	           var username= $("#general_username").val();
	           $.post('', {
            	    get_deposit_history2: "set",
            	    username: username
            	 }, function(data, status){
            	     $("#deposit_history").html(data);
            	 })
	       })


	        $('body').on('click', '.deposit_trs', function(){
                var row= $(this);
                var username= $("#general_username").val();
                var amt= row.data('amt');
                var time= row.data('date');
                var code= row.data('code');
                var id= row.data('id');

                $(".details_deposit_amt").val(amt);
                $(".details_username").val(username);
                $(".details_tx_id").val(code);
                $(".details_deposit_time").val(time);

                $(".details_deposit_time").data('id', id)
                $(".details_deposit_amt").data('id', id)

            })


	        $("body").on('click', '.deposit_actions', function(){
	            var id= $(this).data('id');
	            var action= $(this).data('action');
	            var username= $("#general_username").val();
	            loadOn();
	            $.post('', {
	                deposit_actions: "set",
	                id: id,
	                action: action
	            }, function(data, status){
	                if(data.err === 1){
	                    notify('warning', data.msg)
	                }else if(data.err === 2){
	                    notify('error', data.msg)
	                }else{
	                    notify('success', data.msg)
	                }
	                loadOn();
	                $.post('', {
        	            get_deposit_history2: "set",
        	            username: username
        	        }, function(data, status){
        	            loadOff();
        	            $("#deposit_history").html(data);
        	        })

	            }, "JSON")
	        })





	       // WITHDRAWAL TRANSACTION BLOCK
	       $(".view_with_history").click(function(){
	           var username= $("#general_username").val();
	           $.post('', {
            	    get_with_history2: "set",
            	    username: username
            	 }, function(data, status){
            	     $("#with_history").html(data);
            	 })
	       })


	        $('body').on('click', '.with_trs', function(){
                var row= $(this);
                var username= $("#general_username").val();
                var amt= row.data('amt');
                var time= row.data('date');
                var wallet= row.data('wallet');
                var bank_name = row.data('bank_name');
                var acct_name= row.data('acct_name');
                var acct_no= row.data('acct_no');
                var swift= row.data('swift');
                var id= row.data('id');

                if(bank_name === ""){ //IF COIN
                    $('.with_section_coin').show()
                    $('.with_section_bank').hide()
                    $(".details_with_address").val(wallet);
                }else{ //IF BANK
                    $('.with_section_coin').hide()
                    $('.with_section_bank').show()
                    $(".details_with_bank_name").val(bank_name);
                    $(".details_with_acct_name").val(acct_name);
                    $(".details_with_acct_no").val(acct_no);
                    $(".details_with_swift").val(swift);
                }
                $(".details_with_amt").val(amt);
                $(".details_username").val(username);

                $(".details_with_time").val(time);


                $(".details_with_time").data('id', id)
                $(".details_with_amt").data('id', id)
                $(".details_with_wallet").data('id', id)
                $(".details_with_bank_name").data('id', id)
                $(".details_with_acct_name").data('id', id)
                $(".details_with_acct_no").data('id', id)
                $(".details_with_swift").data('id', id)

            })


	        $("body").on('click', '.with_actions', function(){
	            var id= $(this).data('id');
	            var action= $(this).data('action');
	            var username= $("#general_username").val();
	            loadOn();
	            $.post('', {
	                with_actions: "set",
	                id: id,
	                action: action
	            }, function(data, status){
	                if(data.err === 1){
	                    notify('warning', data.msg)
	                }else if(data.err === 2){
	                    notify('error', data.msg)
	                }else{
	                    notify('success', data.msg)
	                }
	                loadOn();
	                $.post('', {
        	            get_with_history2: "set",
        	            key: '*',
        	            username: username
        	        }, function(data, status){
        	            loadOff();
        	            $("#with_history").html(data);
        	        })

	            }, "JSON")
	        })




             // INVESTMENT BLOCK
	       $(".view_invest_history").click(function(){
	           var username= $("#general_username").val();
	           $("#invest_history").html('<tr colspan=12><td style="font-weight: bold">Fetching '+username+'\'s investment data ...</td></tr>');
	           $.post('', {
            	    get_invest_history2: "set",
            	    username: username
            	 }, function(data, status){
            	     $("#invest_history").html(data);
            	 })
	       })


	       $('body').on('click', '.invest_trs', function(){
                var row= $(this);
                var username= $("#general_username").val();
                var amt= row.data('amt');
                var time= row.data('date');
                var id= row.data('id');

                $(".details_invest_amt").val(amt);
                $(".details_username").val(username);
                $(".details_invest_time").val(time);

                $(".details_invest_time").data('id', id)
                $(".details_invest_amt").data('id', id)

            })


	       $("body").on('click', '.invest_actions', function(){
	            var id= $(this).data('id');
	            var action= $(this).data('action');
	            var username= $("#general_username").val();
	            loadOn();
	            $.post('', {
	                invest_actions: "set",
	                id: id,
	                action: action
	            }, function(data, status){
                    loadOff()
	                if(data.err === 1){
	                    toastr['warning'](data.msg)
	                }else if(data.err === 2){
	                    toastr['error'](data.msg)
	                }else{
	                    toastr['success'](data.msg)
	                }
	                $.post('', {
                	    get_invest_history2: "set",
                	    username: username
                	 }, function(data, status){
                	     $("#invest_history").html(data);
                	 })

	            }, "JSON")
	        })






	        // CRYPTO TRADE BLOCK
	       $(".view_trade_history").click(function(){
	           var username= $("#general_username").val();
	           var rows= $("#trade_rows").val();
	           $("#trade_history").html('<tr><td colspan="15" style="font-weight: bold">Fetching '+username+'\'s crypto trades ...</td></tr>');
	           $.post('', {
            	    get_trade_history: "set",
            	    username: username,
            	    rows: rows,
                    trade: 'trade' //for stock, omit this line
            	 }, function(data, status){
            	     $("#trade_history").html(data);
            	 })
	       })



	        $("body").on('blur', '.a_input', function(){
	            var id= $(this).data('id');
	            var key= $(this).data('name');
	            var value= $(this).val();
	            if(value !== ""){
	                loadOn();
	                $.post('', {
	                    update_order: "set",
	                    value: value,
	                    key: key,
	                    id: id,
                        trade: 'trade' //for stock, omit this line
	                }, function(data, status){
	                    loadOff();
	                    if(data.err === 0){
                            if(data.msg !== ""){
                                notify('success', data.msg)
                            }
	                    }else{
	                        notify('error', data.msg)
	                    }
	                }, "JSON")
	            }else{
	                notify('warning', 'Value cannot be empty')
	            }

	        })



	        $("body").on('click', '.actions', function(){
	            var id= $(this).data('id');
	            var action= $(this).data('action');
	            var rows= $("#rows").val();
	            var username= $("#general_username").val();
	            var trade_rows= $("#trade_rows").val();
	            loadOn();
	            $.post('', {
	                order_actions: "set",
	                id: id,
	                action: action,
                    trade: 'trade' //for stock, omit this line
	            }, function(data, status){
                    loadOff()
	                if(data.err === 1){
	                    notify('warning', data.msg)
	                }else if(data.err === 2){
	                    notify('error', data.msg)
	                }else{
	                    notify('success', data.msg)
                            $.post('', {
                            get_trade_history: "set",
                            username: username,
                            rows: rows,
                                trade: 'trade' //for stock, omit this line
                         }, function(data, status){
                             loadOff();
                             $("#trade_history").html(data);
                         })
	                }

	            }, "JSON")
	        })



	        $("#trade_rows").change(function(){
	            var rows= $("#trade_rows").val();
	            var username= $("#general_username").val();
	            loadOn();
	            $.post('', {
            	    get_trade_history: "set",
            	    username: username,
            	    rows: rows,
                    trade: 'trade'
            	 }, function(data, status){
                    loadOff()
            	     $("#trade_history").html(data);
            	 })
	        })






	       // TASK BLOCK
	        $("#sbmt-task").click(function(){
	            var username= $("#general_username").val();
		           var input= $("#new-task").val();
		           if(input === ""){
		               toastr["warning"]('Input cannot be empty');
		           }else{
		               loadOn();
    		           $.post('', {
    		               tasks: "set",
    		               action: "add",
    		               input: input,
    		               username: username
    		           }, function(data, status){
    		               loadOff();
    		               if(data.err === 0){
    		                   notify('success', data.msg);
    		                   $("#show-tasks").html(data.tasks)
    		                   $("#new-task").val('');
    		               }else{
    		                   notify('error', data.msg)
    		               }
    		           }, "JSON")
		           }
		       })


		       $("body").on('change', '.task-status', function(){
		           var username= $("#general_username").val();
		           var id= $(this).data('id');
		           $.post('', {
    		               tasks: "set",
    		               action: "status",
    		               username: username,
    		               id: id
    		           }, function(data, status){
    		               loadOff();
    		               if(data.err === 0){
    		                   notify('success', data.msg);
    		                   $("#show-tasks").html(data.tasks)
    		               }else{
    		                   notify('error', data.msg)
    		               }
    		           }, "JSON")
		       })


		       $("body").on('click', '.delete-task', function(){
		           var username= $("#general_username").val();
		           var id= $(this).data('id');
		           $.post('', {
    		               tasks: "set",
    		               action: "delete",
    		               username: username,
    		               id: id
    		           }, function(data, status){
    		               loadOff();
    		               if(data.err === 0){
    		                   notify('success', data.msg);
    		                   $("#show-tasks").html(data.tasks)
    		               }else{
    		                   notify('error', data.msg)
    		               }
    		           }, "JSON")
		       })


		       $("body").on('blur', '.old-task', function(){
		           var username= $("#general_username").val();
		           var id= $(this).data('id');
		           var input= $(this).val();
		           if(input !== ""){
    		           $.post('', {
        		               tasks: "set",
        		               action: "edit",
        		               username: username,
        		               id: id,
        		               input: input
        		           }, function(data, status){
        		               if(data.err === 0){
        		                   if(data.msg !== ""){
        		                       notify('success', data.msg);
        		                        $("#show-tasks").html(data.tasks)
        		                   }
        		               }else{
        		                   notify('error', data.msg)
        		               }
        		           }, "JSON")
		           }else{
		               toastr["error"]("Input cannot be empty. Note was not saved");
		           }
		       })


		       $("body").on('click', '.view_note', function(){
		           var username= $("#general_username").val();
		           $.post('', {
    		               tasks: "set",
    		               action: "",
    		               username: username
    		           }, function(data, status){
    		               loadOff();
    		               if(data.err === 0){
    		                   notify('success', data.msg);
    		                   $("#show-tasks").html(data.tasks)
    		               }else{
    		                   notify('error', data.msg)
    		               }
    		           }, "JSON")
		       })





	       // ASSIGN
	       $(".assign").click(function(){
	           var username= $("#general_username").val();
	           $("#assign_body").html('<tr colspan=3><td style="font-weight: bold">Loading agents ...</td></tr>');
    	        $.post('', {
    	            assign: "set",
    	            username: username
    	        }, function(data, status){
    	            $("#assign_body").html(data);
    	        })
	       })


	       $("body").on('change', '.assign_check', function(){
	           var username= $("#general_username").val();
	           var agent_id= $(this).data('agent_id');
	           $.post('', {
    	            assign_check: "set",
    	            username: username,
    	            agent_id: agent_id
    	        }, function(data, status){
    	            $("#assign_body").html(data);
    	            notify('success', 'Action success!');
    	        })
	       })




	        $('body').on('mouseover', '.trs, .tax_trs, .transfer_trs, .deposit_trs, .with_trs, .agents_trs', function(){
	            $(this).css({'background':'#E2EDFF', 'color':'#267DFD', 'cursor':'pointer'})
	        })
	        $('body').on('mouseout', '.trs, .tax_trs, .transfer_trs, .deposit_trs, .with_trs, .agents_trs', function(){
	            $(this).css({'background':'white', 'color':'black', 'cursor':'pointer'})
	        })

	        $("body").on('click', '.actions_admins', function(){
	            var id= $(this).data('id');
	            var username= $(this).data('username');
	            var action= $(this).data('action');
	            loadOn();
	            $.post('ajax', {
	                admins_actions: "set",
	                id: id,
	                action: action,
	                username: username
	            }, function(data, status){
	                if(data.err== 1){
	                    notify('warning', data.msg)
	                }else if(data.err== 2){
	                    notify('error', data.msg)
	                }else{
	                    notify('success', data.msg)
	                }
	                loadOn();
	                $.post('ajax', {
        	            get_signup_history: "set"
        	        }, function(data, status){
        	            loadOff();
        	            $("#members").html(data);
        	        })

	            }, "JSON")
	        })


	    })
	</script>


{% endblock content %}


{% block switcher %}


{% endblock switcher %}