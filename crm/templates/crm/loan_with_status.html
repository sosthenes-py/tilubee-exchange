{% extends "crm/layout.html" %}
{% load static %}

{% block title %}
    <title>Loan History - We Digital</title>
{% endblock %}

{% block content %}

    <style>
        .timeline {
            position: relative;
            padding: 20px 0;
            list-style: none;
        }

        .timeline:before {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 40px;
            width: 2px;
            content: "";
            background-color: #dee2e6;
        }

        .timeline > .timeline-item {
            position: relative;
            margin-bottom: 20px;
            padding-left: 60px;
        }

        .timeline > .timeline-item:before {
            position: absolute;
            left: 30px;
            top: 0;
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #fff;
            border: 5px solid #6A49F2;
            content: "";
        }

        .timeline > .timeline-item .timeline-content {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
        }
    </style>


    <!--start page wrapper -->
    <div class="page-wrapper">
        <div class="page-content">

            <!--end row-->

            <div class="card radius-10 col-12">
                <div class="card-body">

                    <div class="d-flex align-items-center bg-light flex-wrap">
                        <div class="me-auto fw-bold fs-6">{{ status|title }} Loans</div>
                        <div class="d-flex align-items-center flex-wrap">
                            <div class="me-2">
                                <label for="history_month_start" class="form-label me-1">From:</label>
                                <input type="date" id="history_month_start" class="form-control d-inline-block" value=""
                                       style="width: auto;">
                            </div>
                            <div class="me-2">
                                <label for="history_month_end" class="form-label me-1">To:</label>
                                <input type="date" id="history_month_end" class="form-control d-inline-block" value=""
                                       style="width: auto;">
                            </div>
                            <div class="me-2">
                                <label for="history_rows" class="form-label me-1">Rows:</label>
                                <select id="history_rows" class="form-select d-inline-block" style="width: auto;">
                                    <option value="15">15</option>
                                    <option value="50">50</option>
                                    <option selected value="200">200</option>
                                    <option value="500">500</option>
                                    <option value="2000">2000</option>
                                    <option value="10000">2000+</option>
                                </select>
                            </div>
                        </div>
                    </div>


                    <div class="d-flex align-items-center bg-light flex-wrap">
                        <div class="me-auto fw-bold fs-6"></div>
                        <div class="d-flex align-items-center flex-wrap">

                            <div class="me-2">
                                <label for="filter" class="form-label me-1">Filters:</label>
                                <input type="text" placeholder="Search by L.ID, Phone, BVN, Fname, Lname" id="filters" class="form-control d-inline-block" value="">
                            </div>

                            <div class="me-2 ms-3">
                                <label for="overdue_start" class="form-label me-1">Overdue Days: </label>
                                <input type="number" id="overdue_start" class="form-control d-inline-block" placeholder="from" value=""
                                       style="width: 5em;">
                            </div>
                            <div class="me-2">
                                <label for="overdue_end" class="form-label me-1"> - </label>
                                <input type="number" id="overdue_end" class="form-control d-inline-block" placeholder="to" value=""
                                       style="width: 5em;">
                            </div>

                            <div>
                                <button id="search_rdp" type="button" class="btn btn-primary px-3 radius-30"
                                        onclick="start(true)">Search
                                </button>
                            </div>
                        </div>
                    </div>


                    <hr/>
                    <div class="table-responsive">
                        <table class="table align-middle mb-5" id="loan_table">

                            <thead class="table-light">
                            <tr>
                                <th>
                                    <div>
										<input class="form-check-input me-3 all-checkbox border-primary border-2" type="checkbox" value="" aria-label="..." onchange="check_all_loans()">
                                        Loan ID
									</div>
                                </th>
                                <th>Phone</th>
                                <th>Principal</th>
                                <th>Amt Disb <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Amount Disbursed"></i></th>
                                <th>Amt Due</th>
                                <th>Repaid</th>
                                <th>Req Date <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Date Requested"></i></th>
                                <th>Disb Date <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Date Disbursed"></i></th>
                                <th>Due Date</th>
                                <th>Overdue Days</th>
                                <th>Status</th>
                            </tr>
                            </thead>
                            <tbody id="loan_history" style="padding-bottom: 4em !important">

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--end page wrapper -->



    <input type="hidden" id="selected_user_id">
    <input type="hidden" id="selected_loan_id">



    <!--MODAL FOR USER PROFILE-->


    <div id="exampleLargeModal1" tabindex="-1" class="modal fade show" style="display: none;" aria-modal="true"
         role="dialog">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Profile</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"
                            id="close_user"></button>
                </div>


                <div class="modal-body">
                    <div id="user-modal"></div>


                    <div class="page-content">
                        <router-outlet></router-outlet>
                        <app-user-profile>
                            <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
                                <div class="ps-3">
                                    <nav aria-label="breadcrumb">
                                        <ol class="breadcrumb mb-0 p-0">
                                            <li class="breadcrumb-item"><a href="#"><i class="bx bx-home-alt"></i></a>
                                            </li>
                                            <li aria-current="page" class="breadcrumb-item active">Account: <span
                                                    class="details_text_username">John Doe</span></li>
                                        </ol>
                                    </nav>
                                </div>

                                <!---------------TOP ACTIONS------------------->
                                <div class="ms-auto">
                                    <div class="btn-group">
                                        <button data-bs-toggle="dropdown" type="button" class="btn btn-primary">More
                                            Actions
                                        </button>
                                        <button type="button" data-bs-toggle="dropdown"
                                                class="btn btn-primary split-bg-primary dropdown-toggle dropdown-toggle-split">
                                            <span class="visually-hidden">Toggle Dropdown</span></button>
                                        <div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-end">
                                            <a href="#0" class="dropdown-item view_loan_history text-primary"
                                               data-bs-toggle='modal' data-bs-target='#LoanModal'><i
                                                    class="lni lni-cloud-sync"></i> Loans <span
                                                    class="badge rounded-pill bg-primary m-1 loan_count count">0</span></a>

                                            <a href="#0" class="dropdown-item view_repayment_history text-dark"
                                               data-bs-toggle='modal' data-bs-target='#RepaymentModal'><i
                                                    class="lni lni-cloud-upload"></i> Repayments <span
                                                    class="badge rounded-pill bg-dark m-1 repayment_count count">0</span></a>


                                            <a href="#" class="dropdown-item view_timeline text-info-emphasis"
                                               data-bs-toggle='modal' data-bs-target='#TimelineModal'><i
                                                    class="lni lni-video"></i> Timeline</a>


                                            <div class="dropdown-divider"></div>


                                            <a href="#0" class="dropdown-item text-primary assign"
                                               style="font-weight: bold" data-bs-toggle='modal'
                                               data-bs-target='#AssignModal'><i class="lni lni-network"></i> Assign To
                                                Collector</a>


                                            <a href="#0" class="dropdown-item text-primary generate_repayment_link"
                                               style="font-weight: bold"><i class="lni lni-link"></i> Generate Repayment
                                                Link</a>


                                            <div class="dropdown-divider"></div>
                                            <a href="#0" class="dropdown-item text-warning blacklist"
                                               style="font-weight: bold"><i class="lni lni-ban"></i>
                                                Blacklist</a>

                                             <a href="#0" class="dropdown-item text-warning whitelist"
                                               style="font-weight: bold"><i class="lni lni-hand"></i>
                                                Permanent Whitelist</a>

                                            <a href="#" class="dropdown-item" style="color: red; font-weight: bold"
                                               data-bs-toggle='modal' data-bs-target='#EraseUserModal'><i
                                                    class="lni lni-trash"></i> Delete Account</a>
                                        </div>
                                    </div>
                                </div>


                            </div>
                            <div class="container">
                                <div class="main-body">
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="card">
                                                <div class="card-body">


                                                    <!--------------------AVATAR AND USER NAMES---------------------->
                                                    <div class="d-flex flex-column align-items-center text-center">
                                                        <img src="{% static 'crm/images/avatars/user.png' %}"
                                                             alt="Admin" width="110"
                                                             class="rounded-circle p-1 bg-primary details_avatar">
                                                        <div class="mt-3">
                                                            <h4 class="details_fullname"></h4>
                                                            <p class="mb-1 details_status_show"
                                                               style="text-transform: capitalize; font-weight: bold">
                                                                <span class='badge rounded-pill'>AA</span></p>
                                                            <p class="font-size-sm fw-bold">Registered: <span
                                                                    class="details_registered"></span></p>
                                                            <button class="btn btn-primary m-1" data-bs-toggle='modal'
                                                                    data-bs-target='#DocsModal'><i
                                                                    class="fadeIn animated bx bx-book-content"></i> Docs
                                                                <span class="badge bg-light text-primary files_count count">0</span>
                                                            </button>

                                                            <button type="button" class="btn btn-dark view_note"
                                                                    data-bs-toggle='modal' data-bs-target='#NoteModal'>
                                                                <i class="fadeIn animated bx bx-note"></i> Notes <span
                                                                    class="badge bg-secondary notes_count count">0</span>
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <hr class="my-4">


                                                    <!--------------------MINI TRANSACTION HISTORY---------------------->
                                                    <div class="d-flex flex-column align-items-center text-center">
                                                        <h5 style="font-size:1.2em; font-weight: bold">Quick
                                                            Actions</h5>

                                                         <div class="col mt-3">
                                                            <div class="btn-group" role="group" aria-label="Basic example">
                                                                <button type="button" class="btn btn-outline-primary px-3" onclick="check_eligibility()">
                                                                    Check Eligibility
                                                                </button>
                                                                <button type="button" class="btn btn-outline-primary px-3" data-bs-toggle='modal' data-bs-target='#PhoneModal' onclick="load_sms()">
                                                                    Phone Book
                                                                </button>
                                                            </div>
                                                        </div>


                                                    </div>


                                                </div>
                                            </div>
                                        </div>


                                        <!--------------------MAIN PROFILE---------------------->
                                        <style>
                                            .nav-tabs {
                                                display: flex;
                                                width: 100%;
                                                overflow-x: auto; /* Enable horizontal scrolling if necessary */
                                                white-space: nowrap; /* Prevent line breaks */
                                            }

                                            .nav-item {
                                                flex: 1;
                                                min-width: 0; /* Allow items to shrink */
                                            }
                                        </style>

                                        <div class="col-lg-8">

                                            {# --------------------SELECTED USER PROFILE AND OTHER INFO ---------------------------------#}
                                            <div class="card">
                                                <div class="card-body">
                                                    <ul class="nav nav-tabs nav-primary py-2" role="tablist">
                                                        <li class="nav-item" role="presentation">
                                                            <a class="nav-link active" data-bs-toggle="tab"
                                                               href="#contactinfo" role="tab" aria-selected="true">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="tab-icon"><i
                                                                            class="bx bx-user font-18 me-1"></i>
                                                                    </div>
                                                                    <div class="tab-title">Contact Info</div>
                                                                </div>
                                                            </a>
                                                        </li>

                                                        <li class="nav-item" role="presentation">
                                                            <a class="nav-link" data-bs-toggle="tab" href="#bankdetails"
                                                               role="tab" aria-selected="false" tabindex="-1">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="tab-icon"><i
                                                                            class="bx bxs-bank font-18 me-1"></i>
                                                                    </div>
                                                                    <div class="tab-title">Bank Details</div>
                                                                </div>
                                                            </a>
                                                        </li>

                                                        <li class="nav-item" role="presentation">
                                                            <a class="nav-link" data-bs-toggle="tab" href="#loandetails"
                                                               role="tab" aria-selected="false" tabindex="-1">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="tab-icon"><i
                                                                            class="bx bxs-bank font-18 me-1"></i>
                                                                    </div>
                                                                    <div class="tab-title">Loan Details</div>
                                                                </div>
                                                            </a>
                                                        </li>
                                                    </ul>


                                                    {#       -------------------------  CONTACT INFO ----------------------#}
                                                    <div class="tab-content py-3">
                                                        <div class="tab-pane fade active show" id="contactinfo"
                                                             role="tabpanel">


                                                            <div class="card-body">

                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-user"></i>
                                                                            First Name</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="First Name"
                                                                                   aria-label="First Name"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_first_name">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="first_name"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-user font-18"></i>
                                                                            Last Name</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="Last Name"
                                                                                   aria-label="Last Name"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_last_name">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="last_name"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-user"></i>
                                                                            Middle Name</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="Middle Name"
                                                                                   aria-label="Fullname"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_middle_name">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="middle_name"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-mail-send"></i>
                                                                            Email</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="email"
                                                                                   placeholder="Email Address"
                                                                                   aria-label="Email"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_email">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="email"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-mail-send"></i>
                                                                            Secondary Email</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="email"
                                                                                   placeholder="Secondary Email Address"
                                                                                   aria-label="Email"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_email2">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="email2"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-phone"></i>
                                                                            Phone</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="Phone"
                                                                                   aria-label="Phone"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_phone">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="phone"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-phone"></i>
                                                                            Secondary Phone</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text"
                                                                                   placeholder="Secondary Phone"
                                                                                   aria-label="Phone"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_phone2">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="phone2"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-user"></i>
                                                                            Gender</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <select class="form-control details_gender select2">
                                                                                <option value="male">Male</option>
                                                                                <option value="female">Female</option>
                                                                            </select>
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="gender"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-current-location"></i>
                                                                            Address</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="Address"
                                                                                   aria-label="State"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_address">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="address"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-phone"></i>
                                                                            State</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="State"
                                                                                   aria-label="State"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_state">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="state"
                                                                                    data-table="members">Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-phone"></i>
                                                                            LGA</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="LGA"
                                                                                   aria-label="DOB"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_lga">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="lga" data-table="members">
                                                                                Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold"><i
                                                                                class="fadeIn animated bx bx-phone"></i>
                                                                            Date of Birth</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="date" placeholder="DOB"
                                                                                   aria-label="DOB"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_dob">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="dob" data-table="members">
                                                                                Save
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                            </div>


                                                        </div>


                                                        {#       -------------------------  BANK DETAILS ----------------------#}

                                                        <div class="tab-pane fade" id="bankdetails" role="tabpanel">
                                                            <ul class="list-group list-group-flush">
                                                                <h5 class="mt-1 text-primary">Disbursement Bank Details
                                                                    {% if user.level == 'approval admin' or user.level == 'super admin' %}
                                                                    <span class="cursor-pointer badge text-bg-primary" data-bs-toggle="modal" data-bs-target="#modifyBankModal" onclick="fetch_banks()"><i class="bx bx-pen"></i> Modify</span>
                                                                    {% endif %}
                                                                </h5>
                                                                <div class="w-100 border-top mb-2"></div>
                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-building font-18 me-1"></i>
                                                                        Account Number</h6>
                                                                    <span class="text-secondary bankdetails_number">wedigital</span>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-map-pin font-18 me-1"></i>
                                                                        Bank Name</h6>
                                                                    <span class="text-secondary bankdetails_bank">wedigital</span>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-buildings font-18 me-1"></i>
                                                                        Account Name</h6>
                                                                    <span class="text-secondary bankdetails_name">@wedigital</span>
                                                                </li>


                                                                <h5 class="mt-5 text-primary">Virtual Bank Details</h5>
                                                                <div class="w-100 border-top mb-2"></div>

                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-building font-18 me-1"></i>
                                                                        Account Number</h6>
                                                                    <span class="text-secondary virtual_bankdetails_number">wedigital</span>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-map-pin font-18 me-1"></i>
                                                                        Bank Name</h6>
                                                                    <span class="text-secondary virtual_bankdetails_bank">wedigital</span>
                                                                </li>
                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-buildings font-18 me-1"></i>
                                                                        Account Name</h6>
                                                                    <span class="text-secondary virtual_bankdetails_name">@wedigital</span>
                                                                </li>


                                                                <h5 class="mt-5 text-primary">Other Details</h5>
                                                                <div class="w-100 border-top mb-2"></div>

                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-building font-18 me-1"></i>
                                                                        BVN</h6>
                                                                    <span class="text-secondary bankdetails_bvn">wedigital</span>
                                                                </li>

                                                            </ul>
                                                        </div>




                                                         {#       -------------------------  LOAN DETAILS ----------------------#}

                                                        <div class="tab-pane fade" id="loandetails" role="tabpanel">
                                                            <ul class="list-group list-group-flush">
                                                                <h5 class="mt-1 text-primary">Loan Setting</h5>
                                                                <div class="w-100 border-top mb-2"></div>
                                                                <div class="row mb-3">
                                                                    <div class="col-sm-3">
                                                                        <h6 class="mb-0 fw-bold">&#x20A6;
                                                                            Eligible Amt</h6>
                                                                    </div>
                                                                    <div class="col-sm-9 text-secondary">
                                                                        <div class="input-group mb-3">
                                                                            <input type="text" placeholder="Amount eligible"
                                                                                   aria-label="Amount eligible"
                                                                                   aria-describedby="button-addon2"
                                                                                   class="form-control details_eligible_amount">
                                                                            <button type="button" id="button-addon2"
                                                                                    class="btn btn-outline-primary details_save"
                                                                                    data-key="eligible_amount"
                                                                                    data-table="members">Update
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>


                                                                <h5 class="mt-5 text-primary">Other Details</h5>
                                                                <div class="w-100 border-top mb-2"></div>

                                                                <li class="list-group-item d-flex justify-content-between align-items-center flex-wrap">
                                                                    <h6 class="mb-0 fw-bold"><i
                                                                            class="bx bxs-building font-18 me-1"></i>
                                                                        Max Overdue Days</h6>
                                                                    <span class="text-secondary max_overdue_days fw-bold text-danger">-</span>
                                                                </li>


                                                                <h5 class="mt-5 text-primary">Overdue Chart</h5>

                                                                <div id="overdue_chart" data-highcharts-chart="0" style="overflow: hidden;"></div>

                                                            </ul>
                                                        </div>



                                                    </div>
                                                </div>
                                            </div>


                                            <div class="card">

                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </div>


                    </div>
                </div>


            </div>
        </div>
    </div>






    <!--MODAL FOR REPAYMENTS-->

    <div id="RepaymentModal" tabindex="-1" class="modal fade show" aria-modal="true" role="dialog"
         style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">Repayment History</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card border-top border-0 border-4 border-primary">


                        <div class="card-body">

                            <div class="table-responsive">
                                <table class="table align-middle mb-0">
                                    <thead class="table-light">
                                    <tr>
                                        <th>Loan ID <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Unique identifier for the loan"></i></th>
                                        <th>Principal <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Principal loan amount"></i></th>
                                        <th>Due <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Amount Due"></i></th>
                                        <th>PN <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Amount Paid Now"></i></th>
                                        <th>Over Days <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Overdue Days at repayment"></i></th>
                                        <th>TR <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Total Repaid amount so far"></i></th>
                                        <th>Status <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Loan status at repayment"></i></th>
                                        <th>Date <i class="bx bx-info-circle" data-toggle="tooltip" data-placement="top" title="Date of the record"></i></th>
                                    </tr>
                                    </thead>
                                    <tbody id="repayment_history" style="padding-bottom: 4em !important">

                                    </tbody>
                                </table>
                            </div>
                        </div>


                    </div>


                </div>
            </div>
        </div>
    </div>






    <!--MODAL FOR LOANS-->

    <div id="LoanModal" tabindex="-1" class="modal fade show" aria-modal="true" role="dialog" style="display: none;">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">User's Loans</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card border-top border-0 border-4 border-primary">


                        <div class="card-body">

                            <div class="table-responsive">
                                <table class="table align-middle mb-5">
                                    <thead class="table-light">
                                    <tr>
                                        <th>Loan ID</th>
                                        <th>Phone</th>
                                        <th>Principal</th>
                                        <th>Amt Disbursed</th>
                                        <th>Due Amount</th>
                                        <th>Repaid</th>
                                        <th>Requested</th>
                                        <th>Disbursed</th>
                                        <th>Due Date</th>
                                        <th>Overdue Days</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody id="mini_loan_history" style="padding-bottom: 4em !important">

                                    </tbody>
                                </table>
                            </div>
                        </div>


                    </div>


                </div>
            </div>
        </div>
    </div>






   <!--DOCS MODAL	-->
    <div id="DocsModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light doc-title">User Docs </h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card">
                        <div class="card-body">

                            <div class="form-row mt-3" id="show_files">

                            </div>


                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <div class="col-md-2 text-end d-grid me-3">
                        <button type="button" class="btn btn-dark" data-bs-target="#DoccModal" data-bs-toggle="modal">
                            Approve/Reject
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>





    <!--NOTES MODAL	-->
    <div id="NoteModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">User Notes</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card">
                        <div class="card-body">

                            <div class="row gy-3">
                                <div class="col-md-10">
                                    <select id="note_select" class="form-control">
                                        <option value="" disabled selected> --Select collection status--</option>
                                        <option value="promise to pay">Promise To Pay</option>
                                        <option value="break promise">Break Promise</option>
                                        <option value="switched off">Switched Off</option>
                                        <option value="not reachable">Not Reachable</option>
                                        <option value="not picking">Not Picking</option>
                                        <option value="fraudulent">Fraudulent</option>
                                        <option value="payment check request">Payment Check Request</option>
                                        <option value="negotiating">Negotiating</option>
                                        <option value="0">Enter custom note</option>
                                    </select>
                                    <textarea id="note_input"
                                              placeholder="Custom note here.."
                                              class="form-control mt-3" style="display: none"
                                              rows=2></textarea>
                                </div>
                                <div class="col-md-2 text-end d-grid">
                                    <button type="button" class="btn btn-primary" id="add_note">Add Note</button>
                                </div>
                            </div>


                            <div class="form-row mt-3" id="show_notes" style="max-height: 60vh; overflow-y: auto">

                            </div>


                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>




    <!--DEVICE DETAILS MODAL	-->
    <div id="deviceDetailsModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light device_details_name">Device Details</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card">
                        <div class="card-body">

                            <div class="form-row mt-3" id="device_details_show">

                            </div>


                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>




    <!--WAIVE MODAL	-->
    <div id="WaiveModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light device_details_name">Waive Loan</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">

                    <input id="selected_loan" type="hidden">
                    <div class="card">
                        <div class="card-body">

                            <div class="input-group mb-3">
                                <span class="input-group-text">&#x20A6;</span>
                                <input type="number" class="form-control" placeholder="Amount to waive"
                                       aria-label="Amount (to the nearest naira)" id="waive_amount">
                                <span class="input-group-text">.00</span>
                            </div>
                            <button class="btn btn-primary" id="waive_sbmt">
                                {% if user.level == 'super admin' or user.level == 'approval admin' %}
                                    Waive Now
                                {% else %}
                                    Submit waive request
                                {% endif %}
                            </button>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <!--WRITE OFF PART MODAL  wop	-->
    <div id="wopModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light device_details_name">Write Off Part Loan</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">

                    <input id="selected_loan" type="hidden">
                    <div class="card">
                        <div class="card-body">

                            <div class="input-group mb-3">
                                <span class="input-group-text">&#x20A6;</span>
                                <input type="number" class="form-control" placeholder="Amount to write off"
                                       aria-label="Amount (to the nearest naira)" id="wop_amount">
                                <span class="input-group-text">.00</span>
                            </div>
                            {% if user.level == 'super admin' or user.level == 'approval admin' %}
                                <button class="btn btn-primary" id="wop_sbmt">Write Off</button>
                            {% endif %}

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>




    <!--TIMELINE MODAL	-->
    <div id="TimelineModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">User Timelines</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="form-check form-check-primary ms-4">
                                    <input class="form-check-input timeline_names" type="checkbox" value="transfer"
                                           id="flexCheckCheckedSuccess" checked="">
                                    <label class="form-check-label" for="flexCheckCheckedSuccess">
                                        Transfer
                                    </label>
                                </div>

                                <div class="form-check form-check-primary">
                                    <input class="form-check-input timeline_names" type="checkbox" value="manual assign"
                                           id="flexCheckCheckedDanger" checked="">
                                    <label class="form-check-label" for="flexCheckCheckedDanger">
                                        Manual Assign
                                    </label>
                                </div>

                                <div class="form-check form-check-primary">
                                    <input class="form-check-input timeline_names" type="checkbox"
                                           value="collection record" id="flexCheckCheckedDanger" checked="">
                                    <label class="form-check-label" for="flexCheckCheckedDanger">
                                        Collection Record
                                    </label>
                                </div>
                                <div class="form-check form-check-primary">
                                    <input class="form-check-input timeline_names" type="checkbox" value="repayment"
                                           id="flexCheckCheckedWarning" checked="">
                                    <label class="form-check-label" for="flexCheckCheckedWarning">
                                        Repayment
                                    </label>
                                </div>
                                <div class="form-check form-check-primary">
                                    <input class="form-check-input timeline_names" type="checkbox" value="disbursement"
                                           id="flexCheckCheckedDark" checked="">
                                    <label class="form-check-label" for="flexCheckCheckedDark">
                                        Disbursement
                                    </label>
                                </div>


                            </div>
                            <ul class="timeline show_timeline">


                            </ul>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>




    <!--ASSIGN MODAL-->

    <div id="AssignModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">Assign this user to a collector</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card">
                        <div class="card-body">
                            <table class="table mb-0">
                                <thead class="table-primary">
                                <tr>
                                    <th scope="col">Collector</th>
                                    <th scope="col">Total Assigned</th>
                                    <th scope="col">Assign</th>
                                </tr>
                                </thead>
                                <tbody id="assign_body">


                                </tbody>
                            </table>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>



     <!--PHONE MODAL	-->
    <div id="PhoneModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">Phone Book</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">




                    <div class="chat-wrapper">
					<div class="chat-sidebar">
						<div class="chat-sidebar-header">
							<div class="d-flex align-items-center">
								<div class="chat-user-online">
									<img src="{% static 'crm/images/avatars/user.png' %}" width="35" height="35" class="rounded-circle" alt="">
								</div>
								<div class="flex-grow-1 ms-2">
									<p class="mb-0 details_text_username"></p>
								</div>
								<div class="dropdown">
									<div class="cursor-pointer font-24" id="phonebook_reload"><i class="bx bx-loader-circle"></i>
									</div>
								</div>
							</div>
							<div class="mb-3"></div>
							<div class="input-group input-group-sm"> <span class="input-group-text bg-transparent"><i class="bx bx-search"></i></span>
								<input type="text" class="form-control phonebook_search_input" placeholder="Names, phones &amp; messages"> <span class="input-group-text bg-transparent"><i class="bx bx-dialpad"></i></span>
							</div>


							<div class="chat-tab-menu mt-3">
								<ul class="nav nav-pills nav-justified" role="tablist">
									<li class="nav-item" role="presentation">
										<a class="nav-link phonebook_nav active" onclick="load_sms()" data-bs-toggle="pill" href="javascript:;" aria-selected="true" role="tab">
											<div class="font-24"><i class="bx bx-conversation"></i>
											</div>
											<div><small>SMS <span class="phonebook_count text-warning-emphasis" data-item="sms">(0)</span></small>
											</div>
										</a>
									</li>
									<li class="nav-item" role="presentation">
										<a class="nav-link phonebook_nav" onclick="load_call()" data-bs-toggle="pill" href="javascript:;" aria-selected="false" role="tab" tabindex="-1">
											<div class="font-24"><i class="bx bx-phone"></i>
											</div>
											<div><small >Calls <span class="phonebook_count text-warning-emphasis" data-item="call">(0)</span></small>
											</div>
										</a>
									</li>
									<li class="nav-item" role="presentation">
										<a class="nav-link phonebook_nav" data-bs-toggle="pill" href="javascript:;" aria-selected="false" role="tab" tabindex="-1" onclick="load_contact()">
											<div class="font-24"><i class="bx bxs-contact"></i>
											</div>
											<div><small>Contacts <span class="phonebook_count text-warning-emphasis" data-item="contact">(0)</span></small>
											</div>
										</a>
									</li>
									<li class="nav-item" role="presentation">
										<a class="nav-link" data-bs-toggle="pill" href="javascript:;" aria-selected="false" tabindex="-1" role="tab">
											<div class="font-24"><i class="bx bx-bell"></i>
											</div>
											<div><small>Notifications</small>
											</div>
										</a>
									</li>
								</ul>
							</div>
						</div>





						<div class="chat-sidebar-content">
							<div class="tab-content" id="pills-tabContent">
								<div class="tab-pane fade show active" id="pills-Chats">

									<div class="chat-list ps ps--active-y overflow-y-scroll" style="height: 52vh !important;">
										<div class="list-group list-group-flush sms_sidebar" >

                                            <a href="javascript:;" class="list-group-item active">
												<div class="d-flex">
													<div class="flex-grow-1 ms-2">
														<h6 class="mb-0 chat-title">No Data</h6>
														<p class="mb-0 chat-msg">No conversations here yet..</p>
													</div>
													<div class="chat-time"></div>
												</div>
											</a>

										</div>
									</div>
								</div>
							</div>
						</div>
					</div>




					<div class="chat-header d-flex align-items-center">
						<div class="chat-toggle-btn"><i class="bx bx-menu-alt-left"></i>
						</div>
						<div>
							<h4 class="mb-1 font-weight-bold sms_name">...</h4>
							<div class="list-inline d-sm-flex mb-0 d-none"> <a href="javascript:;" class="list-inline-item d-flex align-items-center text-secondary"><small class="bx bxs-circle me-1 chart-online"></small>Last Updated: <span class="sms_last_updated">...</span></a>

							</div>
						</div>
						<div class="chat-top-header-menu ms-auto">
							<a href="#0" class="sms_phone copy"><i class="bx bx-phone"></i></a>
						</div>
					</div>




					<div class="chat-content ps ps--active-y overflow-y-scroll sms_content" >
                        <div style="justify-content: center; height: 100%; align-items: center; display: flex;">
                            <i>Click on a conversation to view...</i>
                        </div>
					</div>


					<div class="overlay chat-toggle-btn-mobile"></div>
					<!--end chat overlay-->
				</div>




                </div>
            </div>
        </div>
    </div>




    <!--DECLINE DIALOG	-->
    <div id="DeclineModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-warning">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">Decline Loan</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body text-white"><p>You are about to decline a loan for the user: <b
                        class="details_text_username"></b>. </p>
                    <p>To proceed, please enter reason for declining</p>

                    <div class="input-group"> <span class="input-group-text">Reason</span>
                        <textarea class="form-control decline_loan_reason" aria-label="Decline Reason" placeholder="You may leave empty to not pass a message"></textarea>
                        <input class="decline_loan_details" type="hidden">
                    </div>
                    <small class="text-danger">*User will be able to view this on their end</small>
                </div>

                <div class="modal-footer">
                    <button type="button" data-bs-dismiss="modal" class="btn btn-light">Close</button>
                    <button data-bs-dismiss="modal" type="button" class="btn btn-dark decline_loan loan_actions">
                        Decline!
                    </button>
                </div>
            </div>
        </div>
    </div>




     <!--REASON SHOW DIALOG	-->
    <div id="ReasonModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="mb-0 reason_head"></h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">
                    <p class="reason_body">...</p>

                <div class="modal-footer">
                    <button type="button" data-bs-dismiss="modal" class="btn btn-light">Close</button>
                </div>
            </div>
        </div>
    </div>
    </div>



{#    CHECKBOX SELECTED MODAL#}
    <div class="modal fade" id="CheckboxSelectedModal" tabindex="-1" aria-modal="true" role="dialog" style="display: none;">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sure to proceed?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">You are about to <span class="fw-bold text-danger"><span class="checkbox-modal-action" style="text-transform: capitalize"></span> All Selected Rows</span>. This action may not be explicitly reversible, proceed?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary checkbox-modal-sbmt" style="text-transform: capitalize" onclick="get_all_checked()">Action</button>
                </div>
            </div>
        </div>
    </div>




    <!--DOC APPROVE/REJECT MODAL	-->
    <div id="DoccModal" tabindex="-1" class="modal fade" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-primary">
                <div class="modal-header">
                    <h5 class="mb-0 text-light">Approve/Reject Docs</h5>
                    <button type="button" data-bs-dismiss="modal" aria-label="Close" class="btn-close"></button>
                </div>
                <div class="modal-body">


                    <div class="card">
                        <div class="card-body">

                            <div class="row gy-3">

                                <div class="input-group"> <span class="input-group-text">Reject Reason</span>
									<textarea class="form-control doc-reason" aria-label="With textarea" placeholder="Work ID is unclear, outdated, we do not accept the submitted docs, etc"></textarea>
								</div>
                                <small class="text-info">You don't have to fill the above for approval</small>

                                <div class="col">
                                    <button type="button" class="btn btn-success doc-decide" data-action="approve" onclick="doc_decide('approve')">Approve Docs</button>

                                    <button type="button" class="btn btn-danger doc-decide" data-action="reject" onclick="doc_decide('reject')">Reject</button>
                                </div>
                            </div>


                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
<i class="bx bx-bl"></i>


    <script>
        const success_audio = new Audio("{% static 'crm/audio/correct.mp3' %}");
        const error_audio = new Audio("{% static 'crm/audio/wrong.mp3' %}");

        var overlay = $("#overlay");
        var loader = $("#loader");

        function loadOn() {
            overlay.css('display', 'block');
            loader.css('display', 'block');
        }

        function loadOff() {
            overlay.css('display', 'none');
            loader.css('display', 'none');
        }

        function onProgress(elem) {
            $('#' + elem).addClass('thin-loader')
        }

        function offProgress(elem) {
            $('#' + elem).removeClass('thin-loader')
        }


        function notify(status, message) {
            if (status === "success" || status === "info") {
                success_audio.play();
            } else {
                error_audio.play();
            }
            toastr[status](message)
        }

        $('#history_month_end').change(function () {
            var start_date = new Date($("#history_month_start").val())
            var end_date = new Date($(this).val())
            if (start_date > end_date) {
                $(this).val(get_current_month())
                $("#history_month_start").val(get_current_month(-1))
                notify('warning', 'Ending date cannot be less than starting date')
            }
        })

        $('#history_month_start').change(function () {
            var end_date = new Date($("#history_month_end").val())
            var start_date = new Date($(this).val())
            if (start_date > end_date) {
                $(this).val(get_current_month(-1))
                $("#history_month_end").val(get_current_month())
                notify('warning', 'Ending date cannot be less than starting date')
            }

        })


        function start(refresh = false) {
            var overdue_start = $('#overdue_start').val()
            var overdue_end = $('#overdue_end').val()
            if(overdue_start !== '' && overdue_end === '' || overdue_start === '' && overdue_end !== ''){
                notify('error', 'Overdue days filter error')
            }else{
                loadOn()
                $.ajax({
                    url: '{% url "loans" %}',
                    data: {
                        action: 'fetch_all_loans',
                        rows: $('#history_rows').val(),
                        start: $('#history_month_start').val(),
                        end: $('#history_month_end').val(),
                        status: '{{ status }}',
                        overdue_start: overdue_start,
                        overdue_end: overdue_end,
                        filters: $('#filters').val(),
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        if (refresh) {
                            $('#loan_table').DataTable().destroy()
                        }
                        setTimeout(function () {
                            $("#loan_history").html(data.content);
                            var table = $('#loan_table').DataTable({
                                lengthMenu: [ [20, 70, 150, -1], [20, 70, 150, "All"] ],
                                pageLength: 20,
                                buttons: ['copy', 'excel', 'pdf', 'print'],
                                ordering: false,
                                columnDefs: [
                                    { "orderable": false, "targets": 0 }
                                ]
                            });
                            table.buttons().container().appendTo('#loan_table_wrapper .col-md-6:eq(0)');
                        }, 10)
                    },
                    error: function (jqXHR, errorThrown) {
                        loadOff()
                        notify('error', 'An error occurred. Page will be refreshed in 3s')
                        setTimeout(function () {
                            {#window.location.update()#}
                        }, 3000)
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            }
        }


        window.e2_chart = undefined;
       function update_overdue_chart(overdue_x, overdue_y, refresh=false){
            if(refresh){
                if (e2_chart !== undefined && e2_chart && typeof e2_chart.destroy === 'function') {
                    e2_chart.destroy();
                }
            }
             var e2 = {
                chart: {
                    foreColor: '#9ba7b2',
                    height: 360,
                    type: 'line',
                    zoom: {
                        enabled: false
                    },
                    dropShadow: {
                        enabled: true,
                        top: 3,
                        left: 2,
                        blur: 4,
                        opacity: 0.1,
                    }
                },
                stroke: {
                    curve: 'smooth',
                    width: 5
                },
                colors: ["#fd3550"],
                series: [{
                    name: "Overdue Days",
                    data: overdue_y
                }],

                markers: {
                    size: 4,
                    strokeWidth: 0,
                    hover: {
                        size: 7
                    }
                },
                grid: {
                    show: true,
                    padding: {
                        bottom: 0
                    }
                },
                labels: overdue_x,
                xaxis: {
                    tooltip: {
                        enabled: false
                    }
                },
                yaxis: {
                    title: {
                        text: 'DAYS'
                    },
                    labels: {
                        formatter: function (val) {
                            return formatNumber(val, 1)
                        }
                    }
                },
                legend: {
                    position: 'top',
                    horizontalAlign: 'right',
                    offsetY: -20
                }
            }
            window.e2_chart = new ApexCharts(document.querySelector('#overdue_chart'), e2);
            e2_chart.render();
       }


       function get_selected_checkbox_action(){
           var html = '';
           var del = ''
           const status = '{{ status }}'
           const level = '{{ user.level }}'
           const allowed_admins = ['super admin', 'approval admin']
           if(status === 'approved'){
               html = `<li><a class="dropdown-item selected-check-action" data-action='disburse' href="#">Disburse all</a></li>
                        <li><a class="dropdown-item selected-check-action" data-action='decline' href="#">Decline all</a></li>`
           }else if(status === 'pending'){
                html = `<li><a class="dropdown-item selected-check-action" data-action='approve' href="#">Approve all</a></li>
                        <li><a class="dropdown-item selected-check-action" data-action='decline' href="#">Decline all</a></li>`
           }else if(status === 'disbursed' && allowed_admins.includes(level)){
               html = `<li><a class="dropdown-item selected-check-action" data-action='write-off' href="#">Write-off all</a></li>`
           }else if(status === 'overdue' && allowed_admins.includes(level)){
               html = `<li><a class="dropdown-item selected-check-action" data-action='write-off' href="#">Write-off all</a></li>`
           }

           if(allowed_admins.includes(level)){
               del = `<li><a class="dropdown-item selected-check-action" data-action='delete' href="#">Delete all</a></li>`
           }

           return `
                <div class="dropdown ms-3 checkbox-btn">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Selected Actions</button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item selected-check-action" data-action='copy_phone' href="#">Copy phones</a></li>
                            ${html}
                            ${del}
                        </ul>
                    </div>
           `
       }

       function check_all_loans(){
           const all_check = $('.all-checkbox').is(':checked') ? 'checked' : 'unchecked'
           if(all_check === 'checked'){
               $('.dt-buttons').append(get_selected_checkbox_action())
           }else{
               $('.checkbox-btn').hide()
           }

           $('.loan-checkbox').each(function(){
               if(all_check === 'checked'){
                   $(this).prop('checked', true)
               }else{
                   $(this).prop('checked', false)
               }
           })
       }

       var checkbox_btn_appended = false
       $('body').on('change', '.loan-checkbox', function(){
           if($('.loan-checkbox:checked').length > 0 && !checkbox_btn_appended){
               checkbox_btn_appended = true
               $('.dt-buttons').append(get_selected_checkbox_action())
           }else if($('.loan-checkbox:checked').length === 0 && checkbox_btn_appended){
               $('.checkbox-btn').hide()
               checkbox_btn_appended = false
           }

        })


        $('body').on('click', '.selected-check-action', function (){
            const action = $(this).data('action')
            if(action === 'copy_phone'){
                var phones = get_all_checked('phone')
                copy_to_clipboard(phones.join(' '))
            }else {
                $('#CheckboxSelectedModal').modal('show')
                $('.checkbox-modal-action').text(action)
                $('.checkbox-modal-sbmt').data('action', action).text('Yes, ' + action)
            }
        })

        function get_all_checked(get='loan_id'){
           var checked = []
            $('.loan_rows').each(function (){
                const check = $(this).find('input')
                if(check.is(':checked')){
                    var item = $(this).data(get)
                    checked.push(item)
                }
            })
            return checked
        }



        $('.checkbox-modal-sbmt').click(function () {
            const checked = get_all_checked()
            loadOn();
            $.ajax({
                url: '{% url "loans" %}',
                data: {
                    action: 'status_update',
                    main_action: $(this).data('action'),
                    qty: 'multiple',
                    loans: JSON.stringify(checked)
                },
                dataType: 'json',
                type: 'post',
                success: function (data) {
                    loadOff()
                    notify(data.status, data.message)
                    start(true)
                    $('#CheckboxSelectedModal').modal('hide')
                },
                error: function (err1, err2) {
                    loadOff()
                    notify('error', JSON.stringify(err1))
                },
                beforeSend: function (xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                }
            })
        })


        function doc_decide(action) {
            const reason = $('.doc-reason').val()
            if (action === 'reject' && reason === '') {
                notify('error', 'Please enter rejection reason')
            } else {
                loadOn();
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        action: 'doc_decide',
                        user_id: $('#selected_user_id').val(),
                        doc_action: action,
                        doc_reason: reason
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        notify(data.status, data.message)
                        $('#DoccModal').modal('hide')
                        if (data.status === "success") {
                            $('.doc-title').html(data.content['html'])
                            $('.user_rows').each(function (){
                                if($(this).data('user_id') === $('#selected_user_id').val()){
                                    $(this).prop({'data-doc_status': data.content['doc_status'], 'data-doc_reason': data.content['doc_reason']})
                                }
                            })
                        }
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            }
        }

    </script>


    <script>
        $(function () {
            console.log(get_current_day(-1))
            $('#history_month_start').val(get_current_day(-1))
            $('#history_month_end').val(get_current_day())

            start()

            $('.device_details').click(function () {
                $('.device_details_name').text($(this).data('name'))
            })

            $('.generate_repayment_link').click(function () {
                notify('error', 'Error generating link')
            })

            $('body').on('click', '.waive', function () {
                var id = $(this).data('id')
                $('#selected_loan').val(id)
            })

            $('#waive_sbmt').click(function () {
                var id = $('#selected_loan').val()
                var amount = $('#waive_amount').val()
                if (amount === 0 || amount === '') {
                    notify('warning', 'Please enter valid amount')
                } else {
                    loadOn();
                    $.ajax({
                        url: '{% url "loans" %}',
                        data: {
                            action: 'waive_loan',
                            loan_id: id,
                            size: 'single',
                            user_id: $('#selected_user_id').val(),
                            amount: amount
                        },
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            loadOff()
                            notify(data.status, data.message)
                            $('#WaiveModal').modal('close')
                            if (data.status === "success") {
                                $('#mini_loan_history').html(data.content)
                                start(true)
                            }
                        },
                        error: function (err1, err2) {
                            loadOff()
                            notify('error', JSON.stringify(err1))
                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                        }
                    })
                }
            })


            $('#wop_sbmt').click(function () {
                var id = $('#selected_loan').val()
                var amount = $('#wop_amount').val()
                if (amount === 0 || amount === '') {
                    notify('warning', 'Please enter valid amount')
                } else {
                    loadOn();
                    $.ajax({
                        url: '{% url "loans" %}',
                        data: {
                            action: 'wop_loan',
                            loan_id: id,
                            size: 'single',
                            user_id: $('#selected_user_id').val(),
                            amount: amount
                        },
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            loadOff()
                            notify(data.status, data.message)
                            $('#wopModal').modal('close')
                            if (data.status === "success") {
                                $('#mini_loan_history').html(data.content)
                                start(true)
                            }
                        },
                        error: function (err1, err2) {
                            loadOff()
                            notify('error', JSON.stringify(err1))
                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                        }
                    })
                }
            })


            $('.assign').click(function () {
                loadOn()
                $.ajax({
                    url: '{% url "operators" %}',
                    data: {
                        action: 'fetch_assigned',
                        loan_id: $('#selected_loan_id').val(),
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        if (data.status === "success") {
                            $('#assign_body').html(data.content)
                        }
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })

            $('body').on('change', '.assign_check', function () {
                var collector_id = $(this).data('collector_id')
                var clicked_elem = $(this)
                var checked = ''
                if ($(this).prop('checked') === true) {
                    checked = 'add'
                } else {
                    checked = 'remove'
                }
                loadOn()
                $.ajax({
                    url: '{% url "operators" %}',
                    data: {
                        action: 'assign',
                        loan_id: $('#selected_loan_id').val(),
                        main_action: checked,
                        collector_id: collector_id
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        notify(data.status, data.message)
                        if (data.status === "success") {
                            $('#assign_body').html(data.content)
                        }
                        if (data.status === "error" && checked === 'add') {
                            clicked_elem.prop('checked', false)
                        } else if (data.status === 'error' && checked === 'remove') {
                            clicked_elem.prop('checked', true)
                        }
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })



            $("body").on('click', '.loan_actions', function () {
                var id = $(this).data('id');
                var user_id = $(this).data('user_id');
                var action = $(this).data('action');
                var size = $(this).data('size');

                if(action === 'declined'){
                    $('.decline_loan').data({'id': id, 'user_id': user_id, 'size': size, 'action': 'decline'})
                    $('#DeclineModal').modal('show')
                }else{
                    var decline_reason = $('.decline_loan_reason').val()
                    action = action === 'decline' ? 'declined' : action
                    loadOn();
                    $.ajax({
                        url: '{% url "loans" %}',
                        data: {
                            action: 'status_update',
                            loan_id: id,
                            main_action: action,
                            size: size,
                            user_id: user_id,
                            reason: decline_reason
                        },
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            loadOff()
                            $('#mini_loan_history').html(data.content)
                            notify(data.status, data.message)
                            start(true)
                        },
                        error: function (err1, err2) {
                            loadOff()
                            notify('error', JSON.stringify(err1))
                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                        }
                    })
                }
            })



            $('body').on('click', '.loan_rows', function (event) {
                if(!$(event.target).hasClass('loan-checkbox')){
                    $('#exampleLargeModal1').modal('show')
                }
                var row = $(this);
                var first_name = row.data('first_name');
                var last_name = row.data('last_name');
                var middle_name = row.data('middle_name');
                var email = row.data('email');
                var email2 = row.data('email2');
                var phone = row.data('phone');
                var phone2 = row.data('phone2');
                var created_at = row.data('created_at');
                var avatar = row.data('avatar');
                var address = row.data('address');
                var dob = row.data('dob');
                var status = row.data('status');
                var gender = row.data('gender');
                var lga = row.data('lga');
                var state = row.data('state');
                var status_pill = row.data('status_pill');
                var id = row.data('user_id');
                var loan_id = row.data('loan_id');
                var eligible_amount = row.data('eligible_amount');
                var doc_status = row.data('doc_status');
                var doc_reason = row.data('doc_reason');

                $(".details_first_name").val(first_name).data('id', id);
                $(".details_last_name").val(last_name).data('id', id);
                $(".details_middle_name").val(middle_name).data('id', id);
                $(".details_email").val(email).data('id', id);
                $(".details_email2").val(email2).data('id', id);
                $(".details_phone").val(phone).data('id', id);
                $(".details_phone2").val(phone2).data('id', id);
                $(".details_address").val(address).data('id', id);
                $(".details_dob").val(dob).data('id', id);
                $(".details_state").val(state).data('id', id);
                $(".details_lga").val(lga).data('id', id);
                $(".details_gender").val(gender).select().data('id', id);
                $(".details_status_show").html(status_pill);
                $(".details_status").data('id', id);
                $(".details_eligible_amount").val(eligible_amount).data('id', id);

                $(".details_avatar").prop('src', avatar);
                $(".details_registered").text(created_at);
                $(".details_current_user").text(id);
                $(".details_text_username").text(last_name + ' ' + first_name + ' (' + id + ')');

                var blacklist_text = status === 'Active' ? 'Blacklist' : 'Whitelist'
                $('.blacklist').html('<i class="lni lni-ban"></i> '+blacklist_text)

                if(doc_status === 'True'){
                    $('.doc-title').html('User Docs  <span class="badge text-bg-success">APPROVED</span>')
                }else{
                    if(doc_reason === ''){
                        $('.doc-title').html('User Docs  <span class="badge text-bg-info">WAITING</span>')
                    }else if(doc_reason === 'submitted'){
                        $('.doc-title').html('User Docs  <span class="badge text-bg-warning">SUBMITTED</span>')
                    }else{
                        $('.doc-title').html('User Docs  <span class="badge text-bg-danger">REJECTED</span>')
                    }
                }


                $("#selected_user_id").val(id);
                $("#selected_loan_id").val(loan_id);

                {#RESET COUNTERS AND ELEMENTS#}
                $('.count').text('0')
                $('#show_notes').html('')

                onProgress('user-modal')

                // HANDLE OTHER DETAILS FETCH
                setTimeout(function () {
                    $.ajax({
                        url: "{% url 'users' %}",
                        dataType: "json",
                        type: "POST",
                        async: true,
                        data: {
                            user_id: id,
                            action: 'get_other_details'
                        },
                        success: function (data) {
                            offProgress('user-modal')
                            {#POPULATE OTHER DETAILS WITH RESPONSE#}
                            $.each(data.content, function (key, value) {
                                if (key !== "tables" && key !== "overdue_chart") {
                                    $('.' + key).text(value)
                                }
                            });
                            $('#show_notes').html(data.content['tables']['notes'])
                            $('#show_files').html(data.content['tables']['files'])
                            update_overdue_chart(data.content['overdue_chart']['x'], data.content['overdue_chart']['y'], true)
                        },
                        error: function () {
                            notify('error', 'Fetch failed, Retry')
                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                        }
                    })

                }, 1100)


            })


            $(".details_save").click(function () {
                var key = $(this).data('key');
                var user_id = $("#selected_user_id").val();
                var value = $(".details_" + key).val();
                loadOn();
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        key: key,
                        value: value,
                        user_id: user_id,
                        action: 'update_user'
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        notify(data.status, data.content)
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })


            // LOANS BLOCK
            $(".view_loan_history").click(function () {
                var user_id = $("#selected_user_id").val();
                loadOn();
                $.ajax({
                    url: '{% url "loans" %}',
                    data: {
                        user_id: user_id,
                        action: 'fetch_loans'
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        $('#mini_loan_history').html(data.content)
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })


            $(".view_repayment_history").click(function () {
                var user_id = $("#selected_user_id").val();
                loadOn();
                $.ajax({
                    url: '{% url "loans" %}',
                    data: {
                        user_id: user_id,
                        action: 'fetch_repayments'
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        $('#repayment_history').html(data.content)
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })


            $('.view_timeline').click(function () {
                var user_id = $("#selected_user_id").val();
                loadOn();
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        user_id: user_id,
                        action: 'get_timeline'
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        $('.show_timeline').html(data.content)
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })

            function updateCheckedList() {
                const checkedValues = [];
                $('.timeline_names:checked').each(function () {
                    checkedValues.push($(this).val());
                });
                return checkedValues
            }

            $('.timeline_names').on('change', function () {
                var names = updateCheckedList()
                $('.timeline-item').each(function () {
                    var name = $(this).data('name')
                    if ($.inArray(name, names) !== -1) {
                        $(this).fadeIn()
                    } else {
                        $(this).fadeOut()
                    }
                })
            });


            {#BLACKLIST#}
            $('.blacklist').click(function (){
                var user_id = $("#selected_user_id").val();
                loadOn();
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        user_id: user_id,
                        action: 'blacklist',
                        main_action: $(this).text()
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        notify(data.status, data.message)
                        if(data.status === 'success'){
                            start(true)
                            $('#exampleLargeModal1').modal('hide')
                        }

                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })

            $('.whitelist').click(function () {
                var user_id = $("#selected_user_id").val();
                loadOn();
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        user_id: user_id,
                        action: 'whitelist'
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        notify(data.status, data.message)
                        if (data.status === 'success') {
                            start(true)
                            $('#exampleLargeModal1').modal('hide')
                        }

                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })




            // NOTE BLOCK
            $("#add_note").click(function () {
                var user_id = $("#selected_user_id").val();
                var input = $("#note_input").val();
                var select = $("#note_select").val();
                if (input === "" && select === "" || select === "0" && input === "" || select === null) {
                    toastr["warning"]('Input cannot be empty');
                } else {
                    let body = (select === '0') ? input : select
                    loadOn();
                    $.ajax({
                        url: '{% url "users" %}',
                        data: {
                            note: body,
                            user_id: user_id,
                            action: 'add_note'
                        },
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            loadOff()
                            $('#note_input').val('')
                            $('#note_select').val('').change()
                            $('#show_notes').html(data.content)
                            notify(data.status, data.message)
                        },
                        error: function (err1, err2) {
                            loadOff()
                            notify('error', JSON.stringify(err1))
                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                        }
                    })
                }
            })

            $('#note_select').change(function (){
                if($(this).val() === '0'){
                    $('#note_input').show()
                }else{
                    $('#note_input').hide()
                }
            })

            $("body").on('click', '.delete_note', function () {
                var user_id = $("#selected_user_id").val();
                var id = $(this).data('id');
                loadOn()
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        note_id: id,
                        user_id: user_id,
                        action: 'delete_note'
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        $('#show_notes').html(data.content)
                        notify(data.status, data.message)
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })


            $("body").on('blur', '.old_note', function () {
                var user_id = $("#selected_user_id").val();
                var id = $(this).data('id');
                var input = $(this).val();
                if (input !== "") {
                    $.ajax({
                        url: '{% url "users" %}',
                        data: {
                            note: input,
                            user_id: user_id,
                            action: 'modify_note',
                            note_id: id
                        },
                        dataType: 'json',
                        type: 'post',
                        success: function (data) {
                            loadOff()
                            notify(data.status, data.message)
                        },
                        error: function (err1, err2) {
                            loadOff()
                            notify('error', JSON.stringify(err1))
                        },
                        beforeSend: function (xhr, settings) {
                            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                        }
                    })
                } else {
                    toastr["error"]("Input cannot be empty. Note was not saved");
                }
            })


            {#PHONEBOOK--------------#}
            {#PHONEBOOK--------------#}
            $('.phonebook_search_input').keyup(function (){
                var key = $(this).val().toLowerCase()
                $('.phonebook_item').each(function (){
                    var phone = String($(this).data('phone')).toLowerCase()
                    var message = String($(this).data('message')).toLowerCase()
                    var name = String($(this).data('name')).toLowerCase()
                    if(phone.startsWith(key) || message.startsWith(key) || name.startsWith(key)){
                        $(this).show()
                    }else{
                        $(this).hide()
                    }
                })
            })

            $('.phonebook_nav').click(function (){
                $('.phonebook_nav').removeClass('active')
                $(this).toggleClass('active')
            })

            $('body').on('click', '.phonebook_item', function (){
                $('.phonebook_item').removeClass('active')
                $(this).toggleClass('active')
            })

            $("body").on('click', '.sms_sidebar_item', function (){
                var user_id = $("#selected_user_id").val();
                var phone = $(this).data('phone')
                loadOn()
                $.ajax({
                    url: '{% url "users" %}',
                    data: {
                        user_id: user_id,
                        action: 'fetch_sms',
                        which: phone
                    },
                    dataType: 'json',
                    type: 'post',
                    success: function (data) {
                        loadOff()
                        if(data.status === 'success'){
                            $('.sms_content').html(data.content['content'])
                            $('.sms_name').text(data.content['name'])
                            $('.sms_phone').data('item', data.content['phone'])
                            $('.sms_last_updated').text(data.content['last_updated'])
                        }
                    },
                    error: function (err1, err2) {
                        loadOff()
                        notify('error', JSON.stringify(err1))
                    },
                    beforeSend: function (xhr, settings) {
                        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")
                    }
                })
            })




            $('body').on('mouseover', '.loan_rows', function () {
                $(this).css({'background': '#E2EDFF', 'color': '#267DFD', 'cursor': 'pointer'})
            })
            $('body').on('mouseout', '.loan_rows', function () {
                $(this).css({'background': 'white', 'color': 'black', 'cursor': 'pointer'})
            })


        })
    </script>

{% endblock %}